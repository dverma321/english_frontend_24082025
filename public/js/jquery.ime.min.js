!function(s){"use strict";var r,t,e,n;function o(t){window.console&&window.console.log&&window.console.log(t)}function i(t){t.static=t.static||{}}function a(t,e){t.parent=e,t.prototype=s.extend({},e.prototype),t.prototype.constructor=e.constructor,t.static=s.extend({},e.static)}function u(t,e,n){this.$element=s(t),this.textEntry=e,s.ime.defaults.languages=Object.keys(s.ime.languages),this.options=s.extend({},s.ime.defaults,n),this.options.imePath&&(s.ime.path=this.options.imePath),this.active=!1,this.shifted=!1,this.inputmethod=null,this.language=null,this.context="",this.options.showSelector&&(this.options.selectorInside=void 0!==n.selectorInside?n.selectorInside:this.$element.hasClass("ime-position-inside"),this.selector=this.$element.imeselector(this.options)),this.listen()}u.prototype={constructor:u,listen:function(){this.$element.on({"keypress.ime":this.keypress.bind(this),"keyup.ime":this.keyup.bind(this),"keydown.ime":this.keydown.bind(this),"destroy.ime":this.destroy.bind(this),"enable.ime":this.enable.bind(this),"disable.ime":this.disable.bind(this)})},getLanguageCodes:function(){return s.ime.defaults.languages},getAutonym:function(t){return s.ime.languages[t].autonym},getInputMethodIds:function(t){return s.ime.languages[t].inputmethods},getInputMethodName:function(t){return s.ime.sources[t].name},getInputMethods:function(t){return this.getInputMethodIds(t).map(function(t){return{id:t,name:s.ime.sources[t].name}})},transliterate:function(t,e,n){var i,o,s,r,a=n?this.inputmethod.patterns_x||[]:this.inputmethod.patterns||[];if("function"==typeof(a=this.shifted?(this.inputmethod.patterns_shift||[]).concat(a):a))return"string"==typeof(n=a.call(this,t,e))?{noop:t===n,output:n}:n;for(r=0;r<a.length;r++)if(o=a[r],i=new RegExp(o[0]+"$"),s=o.slice(-1)[0],i.test(t)){if(3!==o.length)return{noop:!1,output:t.replace(i,s)};if(new RegExp(o[1]+"$").test(e))return{noop:!1,output:t.replace(i,s)}}return{noop:!0,output:t}},keyup:function(t){16===t.which&&(this.shifted=!1)},keydown:function(t){16===t.which&&(this.shifted=!0)},keypress:function(t){var e,n,i=!1;return!this.active||(!this.inputmethod||(8===t.which?!(this.context=""):((t.altKey||t.altGraphKey)&&(i=!0),t.which<32&&13!==t.which&&!i||t.ctrlKey||t.metaKey?!(this.context=""):(e=String.fromCharCode(t.which),n=this.textEntry.getTextBeforeSelection(this.inputmethod.maxKeyLength),i=this.transliterate(n+e,this.context,i),this.context+=e,this.context.length>this.inputmethod.contextLength&&(this.context=this.context.substring(this.context.length-this.inputmethod.contextLength)),!!i.noop||(this.textEntry.replaceTextAtSelection(n.length,i.output),t.stopPropagation(),!1)))))},isActive:function(){return this.active},disable:function(){this.active=!1,s.ime.preferences.setIM("system")},enable:function(){this.active=!0},toggle:function(){this.active=!this.active},destroy:function(){s(document.body).off(".ime"),this.$element.off(".ime").removeData("ime").removeData("imeselector")},getIM:function(){return this.inputmethod},setIM:function(t){this.inputmethod=s.ime.inputmethods[t],s.ime.preferences.setIM(t),this.$element.trigger("imeMethodChange")},setLanguage:function(t){return s.ime.languages[t]?(this.language=t,s.ime.preferences.setLanguage(t),this.$element.trigger("imeLanguageChange"),!0):(o("Language "+t+" is not known to jquery.ime."),!1)},getLanguage:function(){return this.language},load:function(t){return s.ime.load(t)}},i(r=function(){this.TextEntryClasses=[]}),r.prototype.register=function(t){this.TextEntryClasses.unshift(t)},r.prototype.wrap=function(t){var e,n,i;if(t.hasClass("noime"))return null;for(e=0,n=this.TextEntryClasses.length;e<n;e++)if((i=this.TextEntryClasses[e]).static.canWrap(t))return new i(t);return null},r.static.singleton=new r,i(t=function(){}),t.static.canWrap=function(){return!1},t.prototype.getTextBeforeSelection=null,t.prototype.replaceTextAtSelection=null,a(e=function(t){this.$element=t},t),e.static.canWrap=function(t){return t.is("input:not([type]), input[type=text], input[type=search], textarea")&&!t.prop("readonly")&&!t.prop("disabled")},e.prototype.getTextBeforeSelection=function(t){var e=this.$element.get(0);return this.$element.val().substring(Math.max(0,e.selectionStart-t),e.selectionStart)},e.prototype.replaceTextAtSelection=function(t,e){var n=this.$element.get(0),i=n.selectionStart,o=n.scrollTop;n.value=n.value.substring(0,i-t)+e+n.value.substring(n.selectionEnd,n.value.length),n.scrollTop=o,n.selectionStart=n.selectionEnd=i-t+e.length},r.static.singleton.register(e),a(e=function(t){this.$element=t},t),e.static.canWrap=function(t){return t.is("[contenteditable]")},e.prototype.getTextBeforeSelection=function(t){var e=this.getSelectedRange();return e&&e.collapsed&&e.startContainer.nodeType===Node.TEXT_NODE?e.startContainer.nodeValue.substring(Math.max(0,e.startOffset-t),e.startOffset):""},e.prototype.replaceTextAtSelection=function(t,e){var n,i,o,s=window.getSelection(),r=this.getSelectedRange();r&&(this.$element.trigger("compositionstart"),r.collapsed||r.deleteContents(),o=document.createRange(),r.startContainer.nodeType===Node.TEXT_NODE?(n=r.startContainer,i=r.startOffset,n.nodeValue=n.nodeValue.substr(0,i-t)+e+n.nodeValue.substr(i),t=i-t+e.length,o.setStart(r.startContainer,t),o.setEnd(r.startContainer,t)):(n=document.createTextNode(e),r.startContainer.insertBefore(n,r.startContainer.childNodes[r.startOffset]),o.setStart(n,n.length),o.setEnd(n,n.length)),s.removeAllRanges(),s.addRange(o),this.$element.trigger("compositionend"),this.$element.trigger("input"))},e.prototype.getSelectedRange=function(){var t=window.getSelection();return 0===t.rangeCount?null:(t=t.getRangeAt(0),this.$element[0].contains(t.commonAncestorContainer)?t:null)},r.static.singleton.register(e),s.fn.ime=function(o){return this.each(function(){var t,e=s(this),n="object"==typeof o&&o,i=e.data("ime");if(!i){if(!(t=r.static.singleton.wrap(e)))return;i=new u(this,t,n),e.data("ime",i)}"string"==typeof o&&i[o]()})},s.ime={},s.ime.inputmethods={},s.ime.sources={},s.ime.preferences={},s.ime.languages={},s.ime.path="../",s.ime.textEntryFactory=r.static.singleton,s.ime.TextEntry=t,s.ime.inheritClass=a,n={contextLength:0,maxKeyLength:1},s.ime.load=function(i){var t,e=s.Deferred();return s.ime.inputmethods[i]?e.resolve():s.ime.sources[i]?(t=s.ime.sources[i].depends)&&!s.ime.inputmethods[t]?(s.ime.load(t).done(function(){s.ime.load(i).done(function(){e.resolve()})}),e):(o("Loading "+i),(e=s.ajax({url:s.ime.path+s.ime.sources[i].source,dataType:"script",cache:!0}).done(function(){o(i+" loaded")}).fail(function(t,e,n){o("Error in loading inputmethod "+i+" Exception: "+n)})).promise()):e.reject()},s.ime.register=function(t){s.ime.inputmethods[t.id]=s.extend({},n,t)},s.ime.setPath=function(t){s.ime.path=t},s.ime.defaults={languages:[],helpHandler:null,showSelector:!0,selectorInside:void 0}}(jQuery);